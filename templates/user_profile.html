{% extends 'base.html' %}
{% load static %}
{% block title %}–ü—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/profile_style.css' %}">
{% endblock %}

{% block content %}

{% if is_blocked_by_user %}
<div style="text-align: center; padding: 50px;">
    <h2>üö´ –í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º {{ user.full_name }}</h2>
    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω</p>
</div>
{% else %}


<div>
    <h1 style="margin-bottom: 10px;">–ü—Ä–æ—Ñ–∏–ª—å</h1>
</div>

<div class="stats">
    <!-- ==================== 1. –ë–ª–æ–∫ –ø—Ä–æ—Ñ–∏–ª—è ==================== -->
    <div class="profile-card">
        <div class="profile-header">
            <div class="avatar-wrapper">
                <img class="avatar"
                     src="{{ user.profile.avatar.url }}"
                     alt="Profile photo"
                     onclick="openPhotoPreview(this.src)">
            </div>

            <div class="profile-meta">
                <div class="name-age-group">
                    <!-- –ù–æ–≤—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä -->
                    <h1 class="user-name">
                        {{ user.full_name }}
                    </h1>
                    {% if user.profile.age %}

                    <div class="age-display">
                        <span class="age-value">{{ user.profile.age }}</span>
                        <span class="age-label">–ª–µ—Ç</span>

                    </div>
                    {% endif %}
                    <form action="{% url 'send_friend_request' user.id %}" method="post">
                        {% csrf_token %}
                        <button style="margin-top: 15px; " class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –≤ –¥—Ä—É–∑—å—è</button>
                    </form>
                    <div class="actions-group right">
                        <a href="{% url 'messenger_detail' user.id %}"
                           class="btn btn-primary message-btn"
                           style="font-weight: 400; font-size: 14px; height: 39px; display: inline-flex;  align-items: center; justify-content: center; padding: 0 30px; margin-top: 15px; width: 166px;">
                            –ù–∞–ø–∏—Å–∞—Ç—å
                        </a>
                    </div>
                    <div class="block-section">
                        {% if request.user != user %}
                        {% if is_blocked %}
                        <form action="{% url 'unblock_user' user.id %}" method="post">
                            {% csrf_token %}
                            <button style="font-weight: 400; font-size: 14px; height: 39px; display: inline-flex;  align-items: center; justify-content: center; padding: 0 30px; margin-top: 15px; width: 166px;" class="btn btn-dark">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                        </form>
                        {% else %}
                        <form action="{% url 'block_user' user.id %}" method="post">
                            {% csrf_token %}
                            <button style="font-weight: 400; font-size: 14px; height: 39px; display: inline-flex;  align-items: center; justify-content: center; padding: 0 30px; margin-top: 15px; width: 166px;" class="btn btn-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
                        </form>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <div class="bio-section">
            <h3 class="section-title">–û —Å–µ–±–µ</h3>
            <div class="bio-frame">
                <!-- –ù–æ–≤–∞—è —Ä–∞–º–∫–∞ -->
                <p class="bio-text">{{ user.profile.bio }}</p>
            </div>
        </div>
    </div>

    <!-- ==================== 2. –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ ==================== -->
    <div class="stat-box animate rectangle-box skip-box">
        <h2 style="text-align: center; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h2>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/city.svg' %}" class="info-icon" alt="–ì–æ—Ä–æ–¥">
                <h3 class="info-title">–ì–æ—Ä–æ–¥</h3>
            </div>
            <span class="info-content">
                {{ user.profile.city|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/job.svg' %}" class="info-icon" alt="–î–æ–ª–∂–Ω–æ—Å—Ç—å">
                <h3 class="info-title">–î–æ–ª–∂–Ω–æ—Å—Ç—å</h3>
            </div>
            <span class="info-content">
                {{ user.profile.job|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/education.svg' %}" class="info-icon" alt="–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ">
                <h3 class="info-title">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</h3>
            </div>
            <span class="info-content">
                {{ user.profile.education|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/height.svg' %}" class="info-icon" alt="–†–æ—Å—Ç">
                <h3 class="info-title">–†–æ—Å—Ç</h3>
            </div>
            <span class="info-content">
                {{ user.profile.height|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/zodiac_sign.svg' %}" class="info-icon" alt="–ó–Ω–∞–∫_–∑–æ–¥–∏–∞–∫–∞">
                <h3 class="info-title">–ó–Ω–∞–∫ –∑–æ–¥–∏–∞–∫–∞</h3>
            </div>
            <span class="info-content">
                {{ user.profile.zodiac_sign|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/religion.svg' %}" class="info-icon" alt="–†–µ–ª–∏–≥–∏—è">
                <h3 class="info-title">–†–µ–ª–∏–≥–∏—è</h3>
            </div>
            <span class="info-content">
                {{ user.profile.religion|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/alcohol.svg' %}" class="info-icon" alt="–û—Ç–Ω–æ—à–µ–Ω–∏–µ_–∫_–∞–ª–∫–æ–≥–æ–ª—é">
                <h3 class="info-title">–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∞–ª–∫–æ–≥–æ–ª—é</h3>
            </div>
            <span class="info-content">
                {{ user.profile.alcohol|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/smoking.svg' %}" class="info-icon" alt="–û—Ç–Ω–æ—à–µ–Ω–∏–µ_–∫_–∫—É—Ä–µ–Ω–∏—é">
                <h3 class="info-title">–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –∫—É—Ä–µ–Ω–∏—é</h3>
            </div>
            <span class="info-content">
                {{ user.profile.smoking|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/children.svg' %}" class="info-icon" alt="–û—Ç–Ω–æ—à–µ–Ω–∏–µ_–∫_–¥–µ—Ç—è–º">
                <h3 class="info-title">–û—Ç–Ω–æ—à–µ–Ω–∏–µ –∫ –¥–µ—Ç—è–º</h3>
            </div>
            <span class="info-content">
                {{ user.profile.children|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
            </span>
        </div>

        <div class="info-item">
            <div class="info-header">
                <img src="{% static 'icons/language.svg' %}" class="info-icon" alt="–Ø–∑—ã–∫–∏">
                <h3 class="info-title">–Ø–∑—ã–∫–∏</h3>
            </div>
            <span class="info-content">
                {% for lang in profile.language.all %}
                {{ lang.name }}{% if not forloop.last %}, {% endif %}
                {% empty %}
                –ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–ª–µ—á–µ–Ω–∏–π
                {% endfor %}
            </span>
        </div>


    </div>


    <!-- ==================== 3. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è ==================== -->
    <div class="stat-box animate rectangle-box skip-box dlc-block">
        <!-- –§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ -->
        <div class="photos-section">
            <h2>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ ({{ profile.photos.count }})</h2>
            <div class="photos-container">
                {% for photo in profile.photos.all|dictsortreversed:"uploaded_at"|slice:":3" %}
                <div class="{% if forloop.first %}large-photo{% else %}small-photo{% endif %} photo-wrapper">
                    {% if forloop.last and profile.photos.count > 3 %}
                    <div class="blur-container">
                        <img src="{{ photo.image.url }}" class="photo-image" onclick="openPhotoPreview(this.src)">
                    </div>
                    <div class="overlay" onclick="openPhotoModal()">
                        <span class="plus-icon">+{{ profile.photos.count|add:"-2" }}</span>
                    </div>
                    {% else %}
                    <img src="{{ photo.image.url }}" class="photo-image" onclick="openPhotoPreview(this.src)">
                    {% endif %}
                </div>
                {% empty %}
                <div class="large-photo photo-wrapper"></div>
                <div class="small-photo photo-wrapper"></div>
                <div class="small-photo photo-wrapper"></div>
                {% endfor %}
            </div>
        </div>

        <!-- –°–µ–∫—Ü–∏—è "–ò—â—É" -->
        <div class="looking-for">
            <h2>–ò—â—É: {{ user.profile.relationship }}</h2>
        </div>

        <!-- –£–≤–ª–µ—á–µ–Ω–∏—è -->
        <div class="hobbies">
            <h2>–£–≤–ª–µ—á–µ–Ω–∏—è:</h2>
            <div class="hobbies-grid">
                {% for interest in profile.interests.all %}
                <div class="hobby-tile">
                    <img src="{{ interest.image.url }}" alt="{{ interest.name }}" class="hobby-img">
                    <span>{{ interest.name }}</span>
                </div>
                {% empty %}
                <span>–î–æ–±–∞–≤—å—Ç–µ —É–≤–ª–µ—á–µ–Ω–∏—è</span>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- ==================== 4. –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ ==================== -->
    <div class="stat-box animate min-box" onclick="openReviewsModal()" style="cursor: pointer">
        <div class="three-squares">
            <div class="square">
                <div>
                    <h2>–ú—ç—Ç—á–∏</h2>
                    <p class="count">0</p>
                </div>
            </div>

            <div class="square">
                <div class="reviews-summary">
                    <h2>–û—Ç–∑—ã–≤—ã ({{ avg_rating }} / 5)</h2>
                    <div class="rating-stars-big" style="display: flex; gap: 5px; justify-content: center; flex-wrap: nowrap;">
                        {% for _ in "12345" %}
                        <span class="star{% if forloop.counter <= avg_rating %} filled{% endif %}"
                              style="display: inline-block; float: none !important;">‚òÖ</span>
                        {% endfor %}
                    </div>
                    <p class="total-reviews">{{ reviews.count }} –æ—Ç–∑—ã–≤–æ–≤</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –æ—Ç–∑—ã–≤–æ–≤ -->
    <div id="reviewsModal" class="modal" onclick="closeReviewsModal()">
        <div class="modal-content reviews-modal" onclick="event.stopPropagation()">
            <span class="close" onclick="closeReviewsModal()"></span>
            <h2 class="modal-title">–í—Å–µ –æ—Ç–∑—ã–≤—ã ({{ reviews.count }})</h2>

            <div class="reviews-grid">
                {% for review in reviews %}
                <div class="review-card-modal">
                    <div class="review-header-modal">
                        <img src="{{ review.author.profile.avatar.url }}"
                             class="avatar-modal"
                             alt="{{ review.author.full_name }}">
                        <div class="review-author-info">
                            <h3>
                                <a href="{% url 'user_profile' review.author.id %}">{{ review.author.full_name }}</a>
                            </h3>
                            <div class="rating-stars-modal">
                                {% for _ in "12345" %}
                                <span class="star{% if forloop.counter <= review.rating %} filled{% endif %}">‚òÖ</span>
                                {% endfor %}
                            </div>
                        </div>
                        <span class="review-date-modal">{{ review.created_at|date:"d.m.Y H:i" }}</span>
                    </div>
                    <div class="review-text-modal">
                        {{ review.text }}
                    </div>
                </div>
                {% empty %}

                {% endfor %}
            </div>


            {% if can_review %}
            <div class="review-form">
                <form method="post">
                    <h3 class="reviews-heading">–û—Ç–∑—ã–≤—ã ({{ avg_rating }} / 5)</h3>
                    {% csrf_token %}
                    <div class="form-group">
                        <h4 class="form-title">–û—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h4>

                        <div class="rating-input">
                            <label class="rating-label">
                                –û—Ü–µ–Ω–∫–∞:
                                <!-- –ù–∞—á–∏–Ω–∞–µ–º –≤—ã–≤–æ–¥ —Å–æ –≤—Ç–æ—Ä–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ (–∏–Ω–¥–µ–∫—Å 1) -->
                                {% for choice in review_form.rating|slice:"1:" %}
                                <div class="radio-button-wrapper ">
                                    {{ choice.tag }}
                                    <label for="{{ choice.id_for_label }}">
                                        {{ choice.choice_label }}
                                    </label>
                                </div>
                                {% endfor %}
                            </label>
                        </div>

                        <div class="text-area-wrapper">
                            {{ review_form.text }}
                        </div>

                        <button type="submit"
                                name="submit_review"
                                class="btn btn-primary submit-review-btn">
                            –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
                        </button>
                    </div>
                </form>
            </div>
            {% endif %}


        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞ -->
<div id="photoModal" class="modal" onclick="closePhotoModal()">
    <div class="modal-content modal-grid" onclick="event.stopPropagation()">
        <span class="close" onclick="closePhotoModal()"></span>
        {% for photo in profile.photos.all|dictsortreversed:"uploaded_at" %}
        <div class="modal-grid-item">
            <img src="{{ photo.image.url }}"
                 class="gallery-photo"
                 data-delete-url="{% url 'delete_photo' photo.uuid %}"
                 onclick="openPhotoPreview(this.src)">


        </div>
        {% endfor %}
    </div>
</div>

<div id="photoPreviewModal" class="modal" onclick="closePhotoPreview()">
    <div class="preview-wrapper">
        <img src="" class="preview-image" onclick="event.stopPropagation()">
    </div>
</div>

{% endif %}

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/user_script.js' %}"></script>
{% endblock %}